{% extends 'extends/base.html' %} 

{% load static %} {% block custom_stylesheet %}
    <link rel="stylesheet" type="text/css" href="{% static 'plugins/DataTables/datatables.min.css' %}" /> 
{% endblock custom_stylesheet %} 

{% with home='dashboard:home' %} 
{% block tab_title %} VSF - Sites {% endblock tab_title %} 
{% block title %} Sites {% endblock title %} 
{% block sub_title %} List of all available Sites {% endblock sub_title %} 
{% block route %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:site:list_sites' %}">Home</a></li>
<li class="breadcrumb-item active">Sites</li>
{% endblock route %} 


{% block content %}
<div class="container-fluid">

        <button type="button" class="btn btn-info rounded mb-4" data-toggle="modal" data-target="#associateUrl">
            <i class="fa fa-plus"></i> 
            Create site
        </button>
            
        <div class="card rounded" id="sites-list-card">
            <table class="table table-striped" id="sites-list">
                {% csrf_token %}
                <thead>
                    <tr>
                        <th class="text-center text-capitalize" scope="col">Sites</th>
                        <th class="text-center text-capitalize" scope="col">
                            Measurements
                        </th>
                        <th class="text-center text-capitalize" scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    {% for site in sites %}
                    <tr>
                        <th class="text-center text-capitalize" scope="row">
                            <a class="text-dark" href="{% url 'dashboard:site:site_details' id=site.id %}" title="Go to site details">
                            {{ site.name }}
                        </a>
                        </th>
                        <td class="text-center text-capitalize">
                            <a class="text-dark" href="{% url 'dashboard:measurement:list_measurements' %}?site={{ site.id }}">
                Go to measurements
            </a>
                        </td>
                        <td class="text-center text-capitalize">
                            <button type="button" class="btn btn-outline-danger delete-site" id="{{ site.id }}">
                                <i class="fa fa-trash"></i> 
                            </button>
                            
                        </td>
                    </tr>
                    {% empty %}
                    <td colspan="3" class="text-center">
                        <div class="alert alert-danger" role="alert">No sites to show!</div>
                    </td>
                    {% endfor %}
                </tbody>
            </table>
        </div>
     
</div>

{% include "includes/sites-includes/create-sites-modal.html" with site_creation_form=site_creation_form %} 

{% endblock content %} 

{% block custom_scripts %} 

<script type="text/javascript" src="{% static 'plugins/DataTables/datatables.min.js' %}"></script>

<script>
    'use strict';


    $(document).ready(function() {

        /* Creating datatables */
        $('#sites-list').DataTable();

        $(".delete-site").click(function (event) {
    
            event.preventDefault();

            let id  = event.target.id;
            let url = '{% url "sites:delete_site" %}';

            let data = {
                id                 : id,
                csrfmiddlewaretoken: "{{ csrf_token }}"
            };

            Swal.fire({
                icon              : "warning",
                title             : "Do you want to delete this site?",
                showDenyButton    : true,
                confirmButtonText : `Yes`,
                confirmButtonColor: "#ffc107",
                denyButtonText    : `No`
                }).then((result) => {
                    if (result.isConfirmed) {

                        $.ajax({
                        type      : "POST",
                        url       : url,
                        data      : data,
                        success: function (data) {

                            if (data.error === null) {

                            Swal.fire({
                                icon              : "success",
                                title             : "The removal was successful!",
                                confirmButtonColor: "#28a745",
                                confirmButtonText : "Continue"
                            }).then((result) => {

                                if (result.isConfirmed) {

                                location.reload();
                                }
                            });
                            } else {

                            Swal.fire({
                                icon              : "error",
                                title             : "Oops! There was an error deleting the site.",
                                text              : `${data.error}`,
                                confirmButtonColor: "#dc3545",
                                confirmButtonText : "Continue"
                            });
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {

                            Swal.fire({
                            icon              : "error",
                            title             : "There was an error!",
                            text              : `${textStatus}: ${errorThrown}`,
                            confirmButtonColor: "#dc3545",
                            confirmButtonText : "Continue"
                            });
                        },
                        });
                    }
                    });
                });
            });
        
</script>

{% endblock custom_scripts %} 
{% endwith %}