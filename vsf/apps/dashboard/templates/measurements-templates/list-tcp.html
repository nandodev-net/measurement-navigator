
{% extends 'extends/base.html' %}

{% load static %}

{% block custom_stylesheet %}
<link rel="stylesheet" type="text/css" href="{% static 'plugins/DataTables/datatables.min.css' %}" /> 
<link rel="stylesheet" type="text/css" href="{% static 'css/select2.css' %}" /> 

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/pretty-print-json@0.3/dist/pretty-print-json.css"
/>
{% endblock custom_stylesheet %}

{% block tab_title %} VSF - TCP {% endblock tab_title %}
{% block title %} TCP {% endblock title %}

{% block sub_title %} List and filter all the currently available TCP Sub-measurements {% endblock sub_title %}

{% block route %}
<li class="breadcrumb-item">
  <a href="{% url home %}">Home</a>
</li>
<li class="breadcrumb-item">
  <a href="{% url 'dashboard:measurement:list_measurements' %}">Measurements</a>
</li>
<li class="breadcrumb-item active">TCP</li>
{% endblock route %}

{% block content %}
  <nav class="navbar navbar-light bg-light mb-5">
    <form id="urlForm">
      <div class="container-fluid">
        <div class="row">
          <div class="col-3">
            <div class="row align-items-center rounded p-2 bg-info">
              <div class="col-3 mx-auto">
                <label class='font-weight-bold text-white'>
                  Since
                </label>
              </div>
              <div class="col-9 mx-auto">
                <input id="since" class="form-control mr-2 additional-filter" type="date" value="{{ prefill.since }}" name="since"/>
              </div>
            </div> 
          </div>

          <div class="col-3">
            <div class="row align-items-center rounded p-2 bg-info ml-1">
              <div class="col-3 mx-auto">
                <label class='font-weight-bold text-white'>
                  Until
                </label>
              </div>
              <div class="col-9 mx-auto">
                <input id="until" class="form-control mr-2 additional-filter" type="date" value="{{ prefill.until }}" name='until'/>
              </div>
            </div> 
          </div>

          <div class="col-6">
            <div class="row align-items-center rounded p-2 bg-info ml-1 w-100">
              <div class="col-3 mx-auto">
                <label class='font-weight-bold text-white' for="asn">
                  ASN
                </label>
              </div>
              <div class="col-9 mx-auto">
                <select id="asn" class="custom-select additional-filter" name="asn">
                  <option value="">Any ASN</option>
                  {% for asn in asns %}
                    <option 
                    {% if asn.asn == prefill.asn %} selected {% endif %}
                    value="{{ asn.asn }}" 
                    >
                    {{ asn.asn }} - {{ asn.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div> 
          </div>

          <div class="col-3 mt-3">
            <div class="row align-items-center rounded p-2 bg-info">
              <div class="col-3 mx-auto">
                <label class="font-weight-bold text-white" for="anomaly-state">Anomaly</label>
              </div>
              <div class="col-9 mx-auto">
                <select id="anomaly-state" class="custom-select additional-filter" name="anomaly">
                  <option selected value="">Any</option>
                  <option {% if prefill.anomaly == 'false' %} selected {% endif %}
                  value="false">Anomaly False</option>
                  <option {% if prefill.anomaly == 'true'  %} selected {% endif %}
                  value="true">Anomaly True</option>
                </select>
              </div>
            </div> 
          </div>

          <div class="col-6 mt-3">
            <input
              id="input"
              class="form-control additional-filter border-top-0 border-left-0 border-right-0 bg-transparent"
              type="search"
              placeholder="URL"
              aria-label="Search URL"
              name="input"
              value="{{prefill.input}}"
            />
          </div>

          <div class="col-3 mt-3">
            <div class="row align-items-center rounded p-2 bg-info mr-1">
              <div class="col-4 mx-auto">
                <label class="font-weight-bold text-white" for="site">Site</label>
              </div>
              <div class="col-8 mx-auto">
                <select class="custom-select additional-filter" id="site" name="site">
                  <option selected value="">
                    Any Site
                  </option>
                  {% for site in sites %}
                    <option value="{{ site.id }}" title="{{ site.description }}" {% if prefill.site == site.id|stringformat:"i" %} selected {% endif %}>
                      {{ site.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>   
          </div>

          <div class="col-6 mt-3">
            <div class="row align-items-center rounded p-2 bg-info">
              <div class="col-3 mx-auto">
                <label class="font-weight-bold text-white" for="flag">Flag Type</label>
              </div>
              <div class="col-9 mx-auto">
                <select class="custom-select additional-filter select2" id="flag" name="flag" multiple="multiple">
                  {% for flag in flags %}
                    <option {% if prefill.flag == flag.value %} selected {% endif %} value="{{ flag.value }}">
                      {{ flag.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div> 
          </div>


          <div class="col-6 mt-3 my-auto">
            <div class="row align-items-center rounded p-2 bg-info ml-1">
              <div class="col-4 mx-auto">
                <label class="font-weight-bold text-white" for="status-blocked">Blocked</label>
              </div>
              <div class="col-8 mx-auto">
                <select id="status-blocked" class="custom-select additional-filter" name="status_blocked">
                  <option selected value="">Any</option>
                  <option {% if prefill.status_blocked == 'false' %} selected {% endif %}
                  value="false">False</option>
                  <option {% if prefill.status_blocked == 'true' %} selected {% endif %}
                  value="true">True</option>
                </select>
              </div>
            </div>   
          </div>


          <!-- IP -->
          <div class="col-4 mt-3">
            <input
              id="ip"
              class="form-control additional-filter border-top-0 border-left-0 border-right-0 bg-transparent""
              type="search"
              placeholder="IP"
              aria-label="Search By IP"
              name="ip"
              value="{{prefill.ip}}"
            />
          </div>

          <!-- Status Failure -->
          <div class="col-8 mt-3">
            <input
              id="status-failure"
              class="form-control mr-2 additional-filter border-top-0 border-left-0 border-right-0 bg-transparent""
              type="search"
              placeholder="Status Failure"
              aria-label="Search By Failure"
              name="status_failure"
              value="{{prefill.status_failure}}"
            />
          </div>

          <div class="col-4 mt-3">
            <div class="row align-items-center rounded p-2 bg-info">
              <div class="col-4 mx-auto">
                <label class="font-weight-bold text-white" for="status-success">Success</label>
              </div>
              <div class="col-8 mx-auto">
                <select id="status-success" class="custom-select additional-filter" name="status_success">
                  <option selected value="">Any</option>
                  <option {% if prefill.status_success == 'false' %} selected {% endif %}
                  value="false">False</option>
                  <option {% if prefill.status_success == 'true'  %} selected {% endif %}
                  value="true">True</option>
                </select>
              </div>
            </div>   
          </div>

          <div class="col-2 my-auto mx-auto">
            <button id="url-form-button" class="btn btn-outline-info btn-block" type="submit">
              <i class="fa fa-search"></i>
            </button>
          </div>

        </div>
      </div>
    </form>
    <!-- copy-to-clipboard component for search fields -->
    {% include "includes/measurements-includes/copy-clipboard-search-url.html" %}
  </nav>

  <div class="row mb-5">
    <div class="col-6">
      <h4><strong>Last TCP Measurement from:</strong> {{last_measurement_date}}</h4>
    </div>
    <div class="col-6">
      <button type="button" class="btn btn-info rounded" id='info'>
        <i class="fa fa-info-circle"></i> 
      </button>
    </div>
  </div>

  <div class="card rounded" id="domains-list-card">
    <div class="table-responsive">
      <table class="table table-striped mt-5 datatable" id="tcp-list">
        <thead>
          <tr>
            <th class="text-center text-capitalize" scope="col">Input</th>
            <th class="text-center text-capitalize" scope="col">Start Time</th>
            <th class="text-center text-capitalize" scope="col">ASN</th>
            <th class="text-center text-capitalize" scope="col">country</th>
            <th class="text-center text-capitalize" scope="col">Site</th>
            <th class="text-center text-capitalize" scope="col">Anomaly</th>
            <th class="text-center text-capitalize" scope="col">Flag</th>
            <th class="text-center text-capitalize" scope="col">
              Status Blocked
            </th>
            <th class="text-center text-capitalize" scope="col">
              Status Failure
            </th>
            <th class="text-center text-capitalize" scope="col">
              Status Success
            </th>
            <th class="text-center text-capitalize" scope="col">IP</th>
          </tr>
        </thead>

        <tbody id='tcp-tbody'>
        </tbody>

        <tfoot></tfoot>
      </table>
    </div>
  </div>

{% endblock content %}

{% block custom_scripts %}
<script type="text/javascript" src="{% static 'plugins/DataTables/datatables.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/pretty-print-json@0.3/dist/pretty-print-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.min.js"></script>

{% include "includes/js/measurements-includes-js/copy-clipboard-search-url-js.html" %}
<script>
  'use strict';
  var selectedRows = []
  $(document).ready(function() {

      $('.select2').select2({
        theme: "flat",
        allowClear: true,
        placeholder: "Select flags types"
      });

      /* Creating datatable */
      var table = $("#tcp-list").DataTable({
        order: [[1, "desc"]],
        searching: true,
        processing: true,
        language: {
        },
        serverSide: true,
        rowId: "measurement__id",
        ajax: {
          url: '{% url "dashboard:submeasurement:list_tcp_data" %}',
          data: function (data) {
            $('#urlForm *').filter(':input').each(function(){
                if (this.id=='since') data.since = $(this).val();
                if (this.id=='until') data.until = $(this).val();
                if (this.id=='asn') data.asn = $(this).val();
                if (this.id=='consistency') data.consistency = $(this).val();
                if (this.id=='anomaly') data.anomaly = $(this).val();
                if (this.id=='site') data.site = $(this).val();
                if (this.id=='flag') data.flag = $(this).val();
                if (this.id=='status-blocked') data.status_blocked = $(this).val();
                if (this.id=='status-failure') data.status_failure = $(this).val();
                if (this.id=='status-success') data.status_success = $(this).val();
                if (this.id=='ip') data.ip = $(this).val();
            });
          },
          contentType: "application/json; charset=utf-8",  
          type: "GET",
        },
        columns: [
          {
            data: "measurement__raw_measurement__input",
            orderable: true,
            searchable: true,
          },
          {
            data: "measurement__raw_measurement__measurement_start_time",
            orderable: true,
            searchable: true,
          },
          {
            data: "measurement__raw_measurement__probe_asn",
            orderable: true,
            searchable: true,
          },
          {
            data: "measurement__raw_measurement__probe_cc",
            orderable: true,
            searchable: true,
          },
          {
            data: "site_name",
            orderable: true,
            searchable: true,
          },
          {
            data: "measurement__anomaly",
            orderable: true,
            searchable: true,
          },
          {
            data: "flag__flag",
            orderable: true,
            searchable: true,
            render: function (data, type, row, meta) {
              if (data === "ok") {
                return `<div class="text-center text-success">
                          <i title="OK" class="far fa-thumbs-up"></i>
                        </div>`;
              } else if (data === "hard") {
                return `<div class="text-center text-danger">
                          <i title="HARD" class="far fa-flag"></i>
                        </div>`;
              } else {
                return `<div class="text-center text-warning">
                          <i title="SOFT" class="far fa-flag"></i>
                        </div>`;
              }
            },
          },
          {
            data: "status_blocked",
            orderable: true,
            searchable: false,
          },
          {
            data: "status_failure",
            orderable: true,
            searchable: false,
          },
          {
            data: "status_success",
            orderable: true,
            searchable: false,
          },
          {
            data: "ip",
            orderable: true,
            searchable: false,
          },
        ],
        initComplete: function () {},
        select: {
          style: 'multi'
        },
        buttons: [],
      });


      $('#info').attr('disabled','disabled');
      /* Creating datatables */
      var table = $('#tcp-list').DataTable();
      $('#tcp-tbody').on( 'click', 'tr', function () {
        $(this).toggleClass('selected');
        if (table.rows('.selected').data().length > 0) {
          $('#info').removeAttr('disabled');
        } else {
          $('#info').attr('disabled','disabled');
        }

        var index = selectedRows.indexOf(this.id);
        if (index > -1) {
          selectedRows.splice(index, 1);
        } else {
          selectedRows.push(this.id);
        }
      });

  })

  $("#info").click(function() {
    var urls = []
    selectedRows.forEach(function(uuid){
      var url = "{% url 'dashboard:measurement:detail' pk='12341234-1123-1234-1234-121212121212' %}".replace('12341234-1123-1234-1234-121212121212', uuid);
      urls.push(url);
    });

    urls.forEach(function(url){
      window.open(url, '_blank');
    });
    
  });
</script>
{% endblock custom_scripts %}
