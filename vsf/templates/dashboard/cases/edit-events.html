{% extends 'extends/base.html' %}
{% load static %}
{% block custom_stylesheet %}
<link rel="stylesheet" type="text/css" href="{% static 'plugins/DataTables/datatables.min.css' %}" /> 
<style>
  .pcoded-main-container {
      width: -webkit-fill-available;
  }
  table a {
    color: blue;
  }
  .btn {
    border: 1px solid white;
  }

</style>
{% endblock custom_stylesheet %}

{% block tab_title %} VSF - Case {{object.title}} {% endblock tab_title %}
{% block title %} Cases {% endblock title %}
{% block sub_title %} Edit Events of Case {% endblock sub_title %}

{% block route %}

<li class="breadcrumb-item">
  <a href="{% url home %}"><i class="feather icon-home"></i></a>
</li>
<li class="breadcrumb-item">
  <a href="{% url 'dashboard:event_cases:list_cases' %}">Case List</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'dashboard:event_cases:detail_page' object.id %}">Case Detail</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'dashboard:event_cases:edit_events' object.id %}">Edit Events</a>
</li>

{% endblock route %}
{% block content %}

<form method="post">
  <button class="btn btn-primary mb-4 ml-3" id="confirm" type="button">Confirm Edition</button>

  <div class="col-12">
      <div class="card" id="relatedEvents-card">
          <div class="card-header">
            <h5 class="mb-0"><a href="#!" data-toggle="collapse" data-target="#relatedEvents" aria-expanded="true" aria-controls="relatedEvents">Related Events</a></h5>
          </div>
          <div class="collapse show" id="relatedEvents">
              <div class="card-body p-3">
                <table class="table table-striped mt-5 datatable" id="eventsBelonged">
                  <thead>
                      <th class="text-center" scope="col">Event Type</th>
                      <th class="text-center" scope="col">Confirmed</th>
                      <th class="text-center" scope="col">Start Date</th>
                      <th class="text-center" scope="col">End Date</th>
                      <th class="text-center" scope="col">Domain</th>
                      <th class="text-center" scope="col">ASN</th>
                      <th class="text-center" scope="col">Remove from this case?</th>
                  </thead>
                  <tbody>
                      {% for event in events %}
                        <tr id="{{event.id}}">
                          <td>
                            <a href="{% url 'dashboard:events:detail' event.id %}" target="_blank"> {{event.issue_type}} </a>
                          </td>
                          <td> {{event.confirmed}} </td>
                          <td> {{event.start_date}} </td>
                          <td> {{event.end_date}} </td>
                          <td> {{event.domain}} </td>
                          <td> {{event.asn}} </td>
                          <td>
                            <input class="form-check-input del" type="checkbox" value="" id="{{event.id}}">
                          </td>
                        </tr>
                      {% endfor %}
                  </tbody>
                  <tfoot></tfoot>
                </table>
              </div>
          </div>
      </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><a href="#!" data-toggle="collapse" data-target="#events-card" aria-expanded="true" aria-controls="events-card">All Events</a></h5>
      </div>
      <div class="collapse show" id="events-card">
        <div class="card-body p-3">
          <table class="table table-striped mt-5 datatable" id="events">
            <thead>
              <tr>
                <th class="text-center" scope="col"> </th>
                <th class="text-center" scope="col">Event Type</th>
                <th class="text-center" scope="col">Confirmed</th>
                <th class="text-center" scope="col">Start Date</th>
                <th class="text-center" scope="col">End Date</th>
                <th class="text-center" scope="col">Domain</th>
                <th class="text-center" scope="col">ASN</th>
                <th class="text-center" scope="col">Related Case</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

 
  


</form>

{% endblock content %}
{% block custom_scripts %}
<script type="text/javascript" src="{% static 'plugins/DataTables/datatables.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/scripts.js' %}"></script>
<script>

$( '#confirm' ).click(function (e) {
  var eventsSelected = events.rows( { selected: true }).data().toArray().map((selected) => (
    selected.id
  ));

  var eventsToDelete = $('.del:checkbox:checked').toArray().map((selected) => (
    selected.id
  ));

  $.ajax({
    type: "POST",
    url: "{% url 'dashboard:event_cases:edit_events' object.id %}",
    data: {eventsSelected: eventsSelected, eventsToDelete: eventsToDelete, csrfmiddlewaretoken: "{{ csrf_token }}"},
    success: function(data) {
      if (data.error === null) {
        Swal.fire({
            icon: "success",
            title: "Successful linking!",
            confirmButtonColor: "#28a745",
            confirmButtonText: "Continue"
        }).then(result => {
            if (result.isConfirmed) {
                location.reload();
            }
        });
      } else {
        console.log(data)
        Swal.fire({
            icon: "error",
            title: "Error",
            text: `${ data.error }`,
            confirmButtonColor: "#dc3545",
            confirmButtonText: "Continue"
        });
      }
    }
  });
});

var eventsBelonged;
var events;
$(document).ready(function() {
  eventsBelonged = $('#eventsBelonged').DataTable({
    order: [[ 2, "desc" ]],
    searching: true
  });

  events = $('#events').DataTable({
    order: [[ 3, "desc" ]],
    searching: true,
    processing: true,
    language: {
    },
    serverSide: true,
    rowId: "id",
    ajax: {
      url: '{% url "dashboard:events:data" %}',
      data: function (data) {

        data.case = "{{object.id}}";
        console.log(data.case);

      },
      contentType: "application/json; charset=utf-8",  
      type: "GET",
    },
    columnDefs: [ {
        orderable: false,
        className: 'select-checkbox',
        targets:   0
    } ],
    columns: [
      {
        data: 'id',
        orderable: false,
        render: function (data, type, row, meta) { 
          return `<div class="p-2"></div>`
        }
      },
      {
        data: "issue_type",
        orderable: true,
        searchable: true,
      },
      {
        data: "confirmed",
        orderable: true,
        searchable: false,
        render: function (data, type, row, meta) {
          if (data) {
            return `<div class="text-success w-100 text-center">
                      <i class="far fa-check-circle text-success" title="Event is Confirmed"></i>
                    </div>`
          } else {
            return `<div class="text-danger w-100 text-center">
                      <i class="far fa-check-circle text-default" title="Event not Confirmed"></i>
                    </div>`
          }
        },
      },
      {
        data: "start_date",
        orderable: true,
        searchable: true,
      },
      {
        data: "end_date",
        orderable: true,
        searchable: true,
      },
      {
        data: "domain",
        orderable: false,
        searchable: true,
      },
      {
        data: "asn",
        orderable: false,
        searchable: true,
      },
      {
        data: "case",
        orderable: true,
        searchable: true,
      },
    ],
    initComplete: function () {},
    buttons: [],
    select: {
      style: 'multi',
      
    },
  });  
})  
</script>
{% endblock custom_scripts %}