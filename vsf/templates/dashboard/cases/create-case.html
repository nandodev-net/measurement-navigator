{% extends 'extends/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block custom_stylesheet %}
<style>
  .pcoded-main-container {
      width: -webkit-fill-available;;
  }
</style>
<link rel="stylesheet" type="text/css" href="{% static 'plugins/DataTables/datatables.min.css' %}" /> 


{% endblock custom_stylesheet %}

{% block tab_title %} VSF - Cases {% endblock tab_title %}
{% block title %} Create Case {% endblock title %}
{% block sub_title %} Create a new case {% endblock sub_title %}

{% block route %}

<li class="breadcrumb-item">
    <a href="{% url home %}">Home</a>
  </li>
  <li class="breadcrumb-item">
    <a href="{% url 'dashboard:event_cases:create_case' %}">Create Case</a>
  </li>

{% endblock route %}

{% block content %}
  <div class="col-12">
    <form>
      <div class="card p-5">
      
        {% csrf_token %}

        <div class="form-group mb-5">
          <label class="floating-label font-weight-bold" for="title">Title</label>
          <input id="title" class="form-control" type="text" aria-label="Title" name="title" required/>
        </div>

        <div class="row mb-4">
          <div class="col-6">
            <div class="form-group">
              <label class="floating-label font-weight-bold" for="description">Description</label>
              <textarea id="description" class="form-control" type="text" aria-label="Description" name="description" ></textarea>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label class="floating-label font-weight-bold" for="description_eng">Description English</label>
              <textarea id="description_eng" class="form-control" type="text" aria-label="Description English" name="description_eng" ></textarea>
            </div>
          </div>
        </div>
        
        <div class="row mb-5">
          <div class="col-2">
            <label class='font-weight-bold mt-2'>
              Start Date
            </label>
          </div>
          <div class="col-4">
            <input id="start_date" class="form-control mr-2" type="date" name="start_date"/>
          </div>
          <div class="col-2">
            <label class='font-weight-bold mt-2'>
              End Date
            </label>
          </div>
          <div class="col-4">
            <input id="end_date" class="form-control mr-2 additional-filter" type="date" name="end_date"/>
          </div>
        </div>

        <div class="row mb-5">
          <div class="col-2">
            <label class='font-weight-bold mt-2'>
              Select Case Type
            </label>
          </div>
          <div class="col-4">
            <select id="case_type" class="custom-select" name="case_type">
              <option value="Bloqueo"> Bloqueo </option>
              <option value="Desconexion"> Desconexion </option>
              <option value="Relentizacion de servicio en Linea"> 
                Relentizacion de servicio en Linea
              </option>
              <option value="Conexion inusualmente lenta">
                Conexion inusualmente lenta
              </option>
              <option value="Intercepcion de trafico">
                Intercepcion de trafico
              </option>
              <option value="Falla Importante"> Falla Importante </option>
              <option value="DoS" >DoS </option>
            </select>
          </div>
          <div class="col-2">
            <label class='font-weight-bold mt-2'>
              Select Category
            </label>
          </div>
          <div class="col-4">
            <select id="category" class="custom-select additional-filter" name="category" required>
              {% for cat in categoryNames %}
                <option value="{{ cat }}">
                  {{ cat }}
                </option>
              {% endfor %}   
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-9">
            <div class="form-group">
              <label class="floating-label font-weight-bold" for="twitter_search">Twitter Search</label>
              <input id="twitter_search" class="form-control" type="text" aria-label="Twitter Search" name="twitter_search" />
            </div>
          </div>
          <div class="col-3">
            <div class="custom-control custom-switch mt-3 ml-5">
              <input type="checkbox" class="custom-control-input" id="draft_new">
              <label class="custom-control-label font-weight-bold" for="draft_new">Draft</label>
            </div>
          </div>
        </div>

      
      </div>

      <div class="card mt-5" id="events-card">
        <div class="card-header">
          <h5 class="mb-0"><a href="#!" data-toggle="collapse" data-target="#events-to-pick" aria-expanded="true" aria-controls="events-to-pick">Click here to choose the events to be related</a></h5>
        </div>
        <div class="collapse" id="events-to-pick">
            <div class="card-body p-5">
    
              <table class="table table-striped mt-5 datatable" id="events">
                <thead>
                  <tr>
                    <th class="text-center" scope="col"> </th>
                    <th class="text-center" scope="col">Event Type</th>
                    <th class="text-center" scope="col">Confirmed</th>
                    <th class="text-center" scope="col">Start Date</th>
                    <th class="text-center" scope="col">End Date</th>
                    <th class="text-center" scope="col">Domain</th>
                    <th class="text-center" scope="col">ASN</th>
                    <th class="text-center" scope="col">Related Case</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
        </div>
      </div>

      <div class="row">
        <div class="col-10"></div>
        <div class="col-2">
          <button type="button" id="submit_case" class="btn btn-md btn-primary">
            Submit
          </button>
        </div>
      </div>
      
    </form>
  </div>


{% endblock content %}
{% block custom_scripts %}

  <script type="text/javascript" src="{% static 'js/scripts.js' %}"></script>
  <script type="text/javascript" src="{% static 'plugins/DataTables/datatables.min.js' %}"></script>
  <script>
    var events; 

    $(".form-control").each(function() {
        formmat($(this));
    });
    $('.form-control').on('blur', function() {
        formmat($(this));
    });
    $('.form-control').on('focus', function() {
        $(this).parent('.form-group').addClass("fill");
    });

    function formmat(e) {
        var $temp = 0;
        try {
            $temp = e.attr('placeholder').length;
        } catch (err) {
            $temp = 0;
        }
        if (e.val().length > 0 || $temp > 0) {
            e.parent('.form-group').addClass("fill");
        } else {
            e.parent('.form-group').removeClass("fill");
        }
    }

    $( '#submit_case' ).click(function (e) {

      var allowed = true;
      var eventsSelected = events.rows( { selected: true }).data().toArray();
      console.log(eventsSelected);
      eventsSelected.forEach(element => {
        if (element.case !== '-No case related-') {
          allowed = false;
          Swal.fire({
            icon: "warning",
            title: "One of your selected events is already associated with one case",
            confirmButtonColor: "#343a40",
            confirmButtonText: "Continue"
          });
        }
      });

      if (allowed) {
        var eventsID = events.rows( { selected: true }).data().toArray().map((selected) => (
          selected.id
        ));

        var data = {
          title: $( '#title' ).val(), 
          description: $( '#description' ).val(), 
          description_eng: $( '#description_eng' ).val(),
          start_date: $( '#start_date' ).val(), end_date: $( '#end_date' ).val(),
          case_type: $( '#case_type option:selected' ).val(), 
          category: $( '#category option:selected' ).val(),
          twitter_search: $( '#twitter_search' ).val(), draft: $( '#draft' ).is(":checked"),
          events: eventsID, csrfmiddlewaretoken: "{{ csrf_token }}"
        }

        $.ajax({
          type: "POST",
          url: "{% url 'dashboard:event_cases:create_case' %}",
          data: data,
          success: function(data) {
            if (data.error === null) {
              Swal.fire({
                icon: "success",
                title: "Successful Creation!",
                confirmButtonColor: "#28a745",
                confirmButtonText: "Continue"
              }).then(result => {
                if (result.isConfirmed) {
                    window.location = "{% url 'dashboard:event_cases:list_cases' %}";
                }
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Error!",
                text: `${ data.error }`,
                confirmButtonColor: "#dc3545",
                confirmButtonText: "Continue"
              });
            }
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            Swal.fire({
              icon: "error",
              title: "There was an error!",
              text: `${ textStatus }, ${ errorThrown }`,
              confirmButtonColor: "#dc3545",
              confirmButtonText: "Continue"
            });
          }
        });
      }
    });

    $(document).ready(function() {
      events = $('#events').DataTable({
        searching: true,
        processing: true,
        language: {
        },
        serverSide: true,
        rowId: "id",
        order: [[3, "desc"]],
        ajax: {
          url: '{% url "dashboard:events:data" %}',
          data: function (data) {

            data.identification = $("#identification").val() ;
            data.confirmed = $("#confirmed").val();
            data.start_time = $("#start_time").val();
            data.end_time = $("#end_time").val();
            data.public_evidence = $("#public_evidence").val(); 
            data.private_evidence = $("#private_evidence").val();
            data.issue_type = $("#issue_type").val();
            data.domain = $("#domain").val();
            data.asn = $("#asn").val();
            console.log(data);
          },
          contentType: "application/json; charset=utf-8",  
          type: "GET",
        },
        columnDefs: [ {
            orderable: false,
            className: 'select-checkbox',
            targets:   0
        } ],
        columns: [
          {
            data: 'id',
            orderable: false,
            render: function (data, type, row, meta) { 
              return `<div class="p-2"></div>`
            }
          },
          {
            data: "issue_type",
            orderable: true,
            searchable: true,
          },
          {
            data: "confirmed",
            orderable: true,
            searchable: false,
            render: function (data, type, row, meta) {
              if (data) {
                return `<div class="text-success w-100 text-center">
                          <i class="far fa-check-circle text-success" title="Event is Confirmed"></i>
                        </div>`
              } else {
                return `<div class="text-danger w-100 text-center">
                          <i class="far fa-check-circle text-default" title="Event not Confirmed"></i>
                        </div>`
              }
            },
          },
          {
            data: "start_date",
            orderable: true,
            searchable: true,
          },
          {
            data: "end_date",
            orderable: true,
            searchable: true,
          },
          {
            data: "domain",
            orderable: false,
            searchable: true,
          },
          {
            data: "asn",
            orderable: false,
            searchable: true,
          },
          {
            data: "case",
            orderable: true,
            searchable: true,
          },
        ],
        initComplete: function () {},
        buttons: [],
        select: {
          style: 'multi',
        },
      });
    });

  </script>
 
{% endblock custom_scripts %}


