{% extends 'extends/base.html' %}
{% load static %}

{% block custom_stylesheet %}
<link rel=stylesheet
  href="https://cdn.jsdelivr.net/npm/pretty-print-json@0.3/dist/pretty-print-json.css"
/>
<link rel="stylesheet" type="text/css" href="{% static 'plugins/DataTables/datatables.min.css' %}" /> 

<style>
    .pcoded-main-container {
        width: auto;
    }
    #header {
        width: 270%;
    }
    #header-runtime, #failures-card, #dns-card, #tcp-card, #http-card, #generalInfo, #raw-card, #events-card {
        width: -webkit-fill-available;;
    }
    .btn-header-link {
        display: block;
        text-align: left;
        border-bottom: none;
    }
    .btn-header-link:after {
        content: "\f107";
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        float: right;
        margin-top: -5%;
        font-size: 2rem;
    }
    .btn-header-link.collapsed:after {
        content: "\f106";
        float: right;
    }
    .card-header {
        border-bottom: none !important;
    }

</style>
{% endblock custom_stylesheet %}


{% block tab_title %} VSF - Measurement Detail {% endblock tab_title %}
{% block title %} Measurement Detail {% endblock title %}
{% block sub_title %} Specific details of the measurement with id: {{ rawmeasurement.id }}{% endblock sub_title %}

{% block route %}

<li class="breadcrumb-item">
    <a href="{% url home %}"><i class="feather icon-home"></i></a>
</li>
<li class="breadcrumb-item">
  <a href="{% url 'dashboard:measurement:list_measurements' %}">Measurements List</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'dashboard:measurement:detail' pk=rawmeasurement.id %}">Measurement Detail</a>
</li>

{% endblock route %}

{% block content %}

    <div class="card p-5 bg-success" id="header">  
        <div class="row mb-5">
            <div class="col-3"></div>
            <div class="col-6">
                {% block header %} {% endblock header%}
            </div>
            <div class="col-3"></div>
        </div>

        <div class="row mt-4">
            <div class="col-4">
                <img class="ml-4" height="100px" src="{{rawmeasurement.urlFlag}}" />
            </div>
            <div class="col-4">
            </div>
            <div class="col-4">
            </div>
        </div>

        <div class="row ">
            <div class="col-4">
                <h3 class="text-white ml-4">Venezuela</h3>
                <h5 class="font-weight-bold text-white ml-4">Country</h5>
            </div>
            <div class="col-4">
                <h3 class="text-white">{{rawmeasurement.probe_asn}}</h3>
                <h5 class="font-weight-bold text-white">Network</h5>
            </div>
            <div class="col-4">
                <h3 class="text-white ml-4">{{rawmeasurement.test_start_time}}</h3>
                <h5 class="font-weight-bold text-white ml-4">Date & Time</h5>
            </div>
        </div>
    </div>

    <div class="row mb-4" id="header-runtime">
        <div class="col-9">
            <h4 class="ml-4">
                {{beautify_test_name}} Test
            </h4>
        </div>
        <div class="col-3">
            <h4 class="">Runtime: {{rawmeasurement.test_runtime}}</h4>
        </div>
    </div>


    {% if rawmeasurement.test_name == 'web_connectivity' %}
        {% include 'measurements/wconn-detail.html' %}
    {% elif rawmeasurement.test_name == 'tor' %}
        {% include 'measurements/tor-detail.html' %}
    {% endif %}

    <div class="shadow-none p-3 mb-2 bg-secondary rounded" id="generalInfo">
        <p class="text-white"><bold>Report ID: </bold> {{rawmeasurement.report_id}}</p>

        <p class="text-white"><bold>Platform: </bold> {{rawmeasurement.platform}}</p>

        <p class="text-white"><bold>Software Name:</bold> {{rawmeasurement.software_name}} ({{rawmeasurement.software_version}})</p>

        <p class="text-white"><bold>Measurement Engine: </bold> {{rawmeasurement.engine}} </p>
    </div>

    <div class="card py-0 px-5 mt-3" id="raw-card">
        <a href="#!" class="btn btn-header-link collapsed" data-toggle="collapse" data-target="#raw" aria-expanded="true" aria-controls="raw">
            <div class="card-header">
                <h5 class="mb-0">Raw Measurement Data</h5>
            </div>
        </a>
        <div class="collapse" id="raw">
            <div class="card-body">
                <pre id="raw-data"> {{rawmeasurement.rawjson}} </pre>
            </div>
        </div>
    </div>

{% endblock content %}

{% block custom_scripts %}


<script src="https://cdn.jsdelivr.net/npm/pretty-print-json@0.3/dist/pretty-print-json.min.js"></script>
<script type="text/javascript" src="{% static 'plugins/DataTables/datatables.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/scripts.js' %}"></script>

<script>


    $(document).ready(function() {

        /* Case Web Connectivity */
        if ( '{{rawmeasurement.test_name}}' === 'web_connectivity' ) {
            $('#events-table').DataTable({
                order: [[ 2, "desc" ]],
                searching: true,
                language: {
                },
                buttons: [],
                select: {
                style: 'multi',
                },
            });

            if ('{{rawmeasurement.test_keys.http_experiment_failure}}' !== 'None') {
                $( '#http-experiment' ).empty();
                $( '#http-experiment' ).append(
                    '<i class="fas fa-times mr-2"></i>' + '{{rawmeasurement.test_keys.http_experiment_failure}}'
                );
            }
            if ('{{rawmeasurement.test_keys.dns_experiment_failure}}' !== 'None') {
                $( '#dns-experiment' ).empty();
                $( '#dns-experiment' ).append(
                    '<i class="fas fa-times mr-2"></i>' + '{{rawmeasurement.test_keys.dns_experiment_failure}}'
                );
            }
            if ('{{rawmeasurement.test_keys.control_failure}}' !== 'None') {
                $( '#control-experiment' ).empty();
                $( '#control-experiment' ).append(
                    '<i class="fas fa-times mr-2"></i>' + '{{rawmeasurement.test_keys.control_failure}}'
                );
            }
        } else if ( '{{rawmeasurement.test_name}}' === 'web_connectivity' ) {
            var torList = $('#detail-tor-list').DataTable();
        }


        if ('{{rawmeasurement.test_keys.accessible}}' === 'False') {
            $( '#header' ).attr("class", "card p-5 bg-danger")
        }
        
        var raw = $('#raw-data').text();
        rawParsed = JSON.parse(raw);
        rawParsed[0]['fields']['annotations'] = JSON.parse(rawParsed[0]['fields']['annotations']);
        rawParsed[0]['fields']['test_helpers'] = JSON.parse(rawParsed[0]['fields']['test_helpers']);
        jQuery.noConflict();
        $("#raw-data").jsonViewer(rawParsed[0]['fields'], {
            collapsed: true,
            rootCollapsable: false
        });


    });
</script>

{% endblock custom_scripts %}
